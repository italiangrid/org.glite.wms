#!/bin/bash
#
#############
# Copyright (c) Members of the EGEE Collaboration. 2004.
# See http://public.eu-egee.org/partners/ for details on the copyright holders.
# For license conditions see the license file or http://www.eu-egee.org/license.html
#############
#
# Startup script for the WMProxy Service Apache Web Server
#
#############
# processname: httpd
# pidfile: ${GLITE_LOCATION_VAR-/var/glite}/httpd-wmproxy.pid 
# config: ${GLITE_LOCATION-/opt/glite}/etc/glite_wms_wmproxy_httpd.conf 

# Source function library.
#. /etc/rc.d/init.d/functions

#########################################################
#
#                               Integration changes
#. ${GLITE_LOCATION}/etc/glite-wms-vars.sh
#. ${GLITE_LOCATION}/etc/profile.d/glite-wms.sh
#. ${GLITE_LOCATION}/etc/profile.d/glite-wms-config.sh

. /etc/glite/profile.d/glite_setenv.sh 
#########################################################


httpdpath=${GLITE_WMS_WMPROXY_HTTPD-/usr/sbin/httpd}
httpd=`basename $httpdpath`
config=${GLITE_LOCATION-/opt/glite}/etc/glite_wms_wmproxy_httpd.conf
port=${GLITE_WMS_WMPROXY_PORT-7443}
RETVAL=0

# See how we were called.
case "$1" in
  status)
        if ( netstat -lten | grep "^tcp .*:$port .*LISTEN" ) >/dev/null 2>&1 ;then
         echo WMProxy $httpd listening on port $port
         httpd_pids=`/sbin/pidof $httpdpath`
         RETVAL=$?
         if [ ${RETVAL} -eq 0 ]; then
          echo $httpd \(pid $httpd_pids\) is running ....
          echo "==="
          echo WMProxy Server running instances:
          echo "`ps -fC glite_wms_wmproxy_server`"
         fi
        else
         echo WMProxy $httpd NOT listening on port $port
         echo "==="
         echo Checking for other $httpd running instances .....
         if ( /sbin/pidof $httpd ) >/dev/null 2>&1 ; then
          echo $httpd \(pid `/sbin/pidof $httpd`\) is running ....
         else 
          echo None found
         fi
         RETVAL=1
        fi
	;;
  start|stop|restart)
	ps auxwww | awk '/^glite .*[_]wmproxy/ { print $2 }' | xargs -r kill -15
	sleep 5
	ps auxwww | awk '/^glite .*[_]wmproxy/ { print $2 }' | xargs -r kill -ALRM
	sleep 5
	ps auxwww | awk '/^glite .*[_]wmproxy/ { print $2 }' | xargs -r kill -9 
	#$apachectl -k $@ -f $config
	$httpdpath -k $@ -f $config
	RETVAL=$?
	;;
  configtest)
	$httpdpath -t -f $config
	RETVAL=$?
	;;
  *)
	echo $"Usage: glite-wms-wmproxy {start|stop|restart|status|help|configtest}"
	exit 1
esac

exit $RETVAL
