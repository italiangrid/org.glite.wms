<?xml version="1.0"?>
<!--
	Copyright (c) 2004 on behalf of the EU EGEE Project: 
	The European Organization for Nuclear Research (CERN), 
	Istituto Nazionale di Fisica Nucleare (INFN), Italy
	Datamat Spa, Italy
	Centre National de la Recherche Scientifique (CNRS), France
	CS Systeme d'Information (CSSI), France
	Royal Institute of Technology, Center for Parallel Computers (KTH-PDC), Sweden
	Universiteit van Amsterdam (UvA), Netherlands
	University of Helsinki (UH.HIP), Finland
	University of Bergen (UiB), Norway
	Council for the Central Laboratory of the Research Councils (CCLRC), United Kingdom

	EGEE Middleware Test WMS Configuration Specification File
	
	Authors: Alberto Di Meglio <alberto.di.meglio@cern.ch>		
	Version info: $Id$
	Release: $Name$

	Revision history:
	$Log$
	Revision 1.11  2004/05/05 23:21:04  dimeglio
	Updated Jalopy dependencies

	Revision 1.10  2004/05/05 23:05:17  dimeglio
	Removed import of external dependencies file, dependencies are
	explicitly set. This is necessary to be able to run the subsystem CSF
	without extracting org.egee manually
	
	Revision 1.9  2004/05/03 00:30:57  dimeglio
	Added jcommon component to subsystem dependencies
	
	Revision 1.8  2004/05/03 00:28:12  dimeglio
	Added jcommon component to subsystem dependencies
	
	Revision 1.7  2004/04/29 04:36:56  dimeglio
	Fixed dependency spelling errors
	
	Revision 1.6  2004/04/29 04:05:04  dimeglio
	Moved user property look up before dependencies properties
	
	Revision 1.5  2004/04/29 03:39:47  dimeglio
	Added Import of  user and project properties
	
	Revision 1.4  2004/04/29 03:30:23  dimeglio
	Replaced list of dependencies with common dependencies file
	
	Revision 1.3  2004/04/29 02:43:34  dimeglio
	Added check for presence of junit.runner class
	
	Revision 1.2  2004/04/29 01:42:09  dimeglio
	Added dependencies to csf files
	
	Revision 1.1  2004/04/29 01:36:29  dimeglio
	Added org.egee.test3.wms
	
-->


<project name="EGEE Middleware Test2 WMS CSF" default="all">

	<!-- Proxy settings, default values can be overriden by user -->
	<property name="proxyhost" value="" />
	<property name="proxyport" value="80" />
	<setproxy proxyhost="${proxyhost}" proxyport="${proxyport}"/>

	<!-- ========================================================
		 Checkout/updates the EGEE Middleware Test2 WMS components
		 ======================================================== -->
	
	<!-- Default workspace location is module parent directory -->
	<!-- Override from command line -->
	<property name="workspace.dir" location="../.." />
	<property name="repository" location="${workspace.dir}/repository" />
	
	<!-- Load environment variables -->
	<property environment="env" />
	
	<!-- Load subsystem dependencies file -->
	<property file="subsystem.dependencies.properties" />
	
	<!-- Default update mode - Override from command line -->
	<property name="update" value="false" />
	
	<!-- Set org.egee update mode -->
	<condition property="egee.uptodate">
		<and>
			<isfalse value="${update}" />
			<available file="${workspace.dir}/org.egee" type="dir" />
		</and>
	</condition>

	<!-- Set org.egee.test3 update mode -->
	<condition property="uptodate">
		<isfalse value="${update}" />
	</condition>

	<!-- Location of user property files -->
	<property name="user.properties.file" location="${user.home}/egee.build.properties"/>
	
	<!-- Load user-specific property files -->
	<property file="${user.properties.file}"/>
	
	<!-- Load module-specific property file -->
	<property file="build.properties"/>

	<!-- =====================================================
		 Self-update if required
		 ===================================================== -->
		
	<!-- Load subsystem dependencies file -->
	<property file="dependencies.properties" />

	<!-- Update main EGEE module -->
	<target name="org.egee" unless="egee.uptodate">
		<cvs command="checkout"
        	package="org.egee"
        	dest="${workspace.dir}"
        	tag="${org.egee.version}"/>
		<fail>The org.egee module has been updated, please rerun the configuration file</fail>
	</target>

	<!-- Update the current module -->
	<target name="org.egee.test3.wms" unless="uptodate">
		<cvs command="checkout"
        	package="org.egee.test3.wms"
        	dest="${workspace.dir}"
        	tag="${org.egee.test3.wms.version}" />
		<fail>The org.egee.test3.wms module has been updated, please rerun the configuration file</fail>
	</target>

	<!-- Load master dependencies file -->
	<property file="${workspace.dir}/org.egee/project/dependencies.properties" />
	
	<!-- *****************************************************-->
	<!-- Environmental checks                                 -->
	<!-- *****************************************************-->
	
	<!-- All environmental checks -->
	<target name="envchecks" depends="oscheck,javacheck,antcheck,gcccheck" />

	<target name="oscheck">
		<!-- Operating system -->
		<condition property="isWindows">
			<os family="windows"/>
		</condition>
		<condition property="isUnix">
			<os family="unix"/>
		</condition>
		<echo>Operating system:		${os.name}</echo>
	</target>
			
	<target name="javacheck">
		<!-- Java version -->
		<condition property="isJavaOk">
			<contains string="${java.version}" substring="${egee.java.version}"/>
		</condition>
		<echo>Java version:		${java.version}</echo>
		<fail unless="isJavaOk">Java JRE version must be ${egee.java.version}_XX</fail>
		<echo>JAVA_HOME:			${env.JAVA_HOME}</echo>
	</target>
			
	<target name="antcheck">
		<!--  Ant -->
		<condition property="isAntOk">
			<contains string="${ant.version}" substring="${egee.ant.version}"/>
		</condition>
		<echo>Ant version:		${ant.version}</echo>
		<fail unless="isAntOk">Ant version must be ${egee.ant.version}</fail>
		<echo>ANT_HOME:			${env.ANT_HOME}</echo>
	</target>
		
	<target name="gcccheck" if="isUnix">
		<!-- Gcc compiler version -->
		<exec executable="gcc" outputproperty="detected.gcc.version">
			<arg line="-dumpversion" />
		</exec>
		<condition property="isGccOk">
			<equals arg1="${detected.gcc.version}" arg2="${egee.gcc.version}"/>
		</condition>
		<echo>Gcc version:		${detected.gcc.version}</echo>
		<fail unless="isGccOk">Gcc version must be ${egee.gcc.version}</fail>
		<exec executable="which" outputproperty="detected.gcc.path">
			<arg line="gcc" />
		</exec>
		<echo>gcc path:			${detected.gcc.path}</echo>
	</target>
	
	<!-- *****************************************************-->
	<!-- Development tools                                    -->
	<!-- *****************************************************-->
	
	<!-- All development tools -->
 	<target name="devtools" depends="junitcheck,
					 junit,
 									 checkstyle,
 									 jalopy,
 									 cpptasks"/>		

	<!-- Check if junit is already installed -->
	<target name="junitcheck">
		<available classname="junit.runner.Version" property="is.junit.present"/>
	</target>

	<!--  JUnit -->
 	<target name="junit" unless="is.junit.present">		
		<mkdir dir="${repository}/${junit.name}" />
		<get src="${junit.url}/junit.jar"
			 dest="${repository}/${junit.name}/junit.jar"
			 verbose="on"
			 usetimestamp="true" />

		<!-- Copy junit jar to Ant lib directory, needed to run JUnit task -->
		<copy file="${repository}/${junit.name}/junit.jar"
			tofile="${env.ANT_HOME}/lib/junit.jar"/>
	</target>

	<!--  CheckStyle -->
 	<target name="checkstyle">		
		<mkdir dir="${repository}/${checkstyle.name}" />
		<get src="${checkstyle.url}/checkstyle-all-3.3.jar"
			 dest="${repository}/${checkstyle.name}/checkstyle-all-3.3.jar"
			 verbose="on"
			 usetimestamp="true" />
	</target>

	<!--  Jalopy -->
 	<target name="jalopy">		
		<mkdir dir="${repository}/${jalopy.name}" />
		<get src="${jalopy.url}/lib/jalopy-ant-0.6.1.jar"
			 dest="${repository}/${jalopy.name}/jalopy-ant-0.6.1.jar"
			 verbose="on"
			 usetimestamp="true" />
		<get src="${jalopy.url}/lib/jalopy-1.0b10.jar"
			 dest="${repository}/${jalopy.name}/jalopy-1.0b10.jar"
			 verbose="on"
			 usetimestamp="true" />
		<get src="${jalopy.url}/lib/jdom-1.0b8.jar"
			 dest="${repository}/${jalopy.name}/jdom-1.0b8.jar"
			 verbose="on"
			 usetimestamp="true" />
		<get src="${jalopy.url}/lib/oro-2.0.6.jar"
			 dest="${repository}/${jalopy.name}/oro-2.0.6.jar"
			 verbose="on"
			 usetimestamp="true" />
	</target>

	<!--  CPPTasks -->
 	<target name="cpptasks">		
		<mkdir dir="${repository}/${cpptasks.name}" />
		<get src="${cpptasks.url}/cpptasks.jar"
			 dest="${repository}/${cpptasks.name}/cpptasks.jar"
			 verbose="on"
			 usetimestamp="true" />
	</target>

	<!-- =====================================================
		 External libraries
		 ===================================================== -->
	
	<!--  All external libraries -->
 	<target name="external" depends="globus,boost,classads,jclassads"/>
 	
	<!-- Globus Libraries and Includes-->
	<target name="globus" unless="offline.repository">                                                                                                   
		<mkdir dir="${repository}/${globus.name}" />
		<get src="${globus.url}/globus.tar.gz"
			 dest="${repository}/${globus.name}/globus.tar.gz"
			 verbose="on"
			 usetimestamp="true" />
		<uptodate property="globus.old" targetfile="${repository}/${globus.name}/globus.tar.gz">
			<srcfiles dir="${repository}/${globus.name}" includes="**/*.h" />
		</uptodate>
		<antcall target="globus-expand" />
	</target>
 	<target name="globus-expand" if="globus.old">		
                <delete>
                        <fileset dir="${repository}/${globus.name}">
				<include name="**/*" />
                                <exclude name="globus.tar.gz" />
                        </fileset>
                </delete>
		<exec dir="${repository}/${globus.name}" executable="tar">
			<arg line="-xzf globus.tar.gz" />
		</exec>
		<touch>
			<fileset dir="${repository}/${globus.name}">
				<exclude name="globus.tar.gz" />
			</fileset>
		</touch>
	</target>

	<!-- Boost Libraries and Includes-->
 	<target name="boost" unless="offline.repository">	
		<mkdir dir="${repository}/${boost.name}" />
		<get src="${boost.url}/boost.tar.gz"
			 dest="${repository}/${boost.name}/boost.tar.gz"
			 verbose="on"
			 usetimestamp="true"
			 ignoreerrors="true" />
		<uptodate property="boost.old" targetfile="${repository}/${boost.name}/boost.tar.gz">
			<srcfiles dir="${repository}/${boost.name}" includes="**/*.h" />
		</uptodate>
		<antcall target="boost-expand" />
	</target>
 	<target name="boost-expand" if="boost.old">
                <delete>
                        <fileset dir="${repository}/${boost.name}">
				<include name="**/*" />
                                <exclude name="boost.tar.gz" />
                        </fileset>
                </delete>
		<exec dir="${repository}/${boost.name}" executable="tar">
			<arg line="-xzf boost.tar.gz" />
		</exec>
		<touch>
			<fileset dir="${repository}/${boost.name}">
				<exclude name="boost.tar.gz" />
			</fileset>
		</touch>
	</target>

	<!-- ClassADs Libraries and Includes-->
 	<target name="classads" unless="offline.repository">		
		<mkdir dir="${repository}/${classads.name}" />
		<get src="${classads.url}/classads.tar.gz"
			 dest="${repository}/${classads.name}/classads.tar.gz"
			 verbose="on"
			 usetimestamp="true"
			 ignoreerrors="true" />
		<uptodate property="classads.old" targetfile="${repository}/${classads.name}/classads.tar.gz">
			<srcfiles dir="${repository}/${classads.name}" includes="**/*.h" />
		</uptodate>
		<antcall target="classads-expand" />
	</target>
 	<target name="classads-expand" if="classads.old">
		<delete>
			<fileset dir="${repository}/${classads.name}">
				<include name="**/*" />
				<exclude name="classads.tar.gz" />
			</fileset>
		</delete>
		<exec dir="${repository}/${classads.name}" executable="tar">
			<arg line="-xzf classads.tar.gz" />
		</exec>
		<touch>
			<fileset dir="${repository}/${classads.name}">
				<exclude name="classads.tar.gz" />
			</fileset>
		</touch>
	</target>

    <!--  Java ClassAds -->
    <target name="jclassads" unless="offline.repository">
            <mkdir dir="${repository}/${jclassads.name}" />
            <get src="${jclassads.url}/classad.jar"
                     dest="${repository}/${jclassads.name}/classad.jar"
                     verbose="on"
                     usetimestamp="true" />
    </target>

	<!-- =====================================================
		 EGEE Middleware modules
		 ===================================================== -->
	
	<!-- All project modules -->
 	<target name="project" depends="thirdparty-globus_ssl_utils,
 								    thirdparty-bypass,
 								    thirdparty-globus_gridftp_server,
 								    thirdparty-loki,
 								    common,
 								    jcommon"/>

	<!-- Globus SSLUtils -->
 	<target name="thirdparty-globus_ssl_utils">		
		<cvs command="checkout"
			package="org.egee.test3.wms.thirdparty-globus_ssl_utils"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.thirdparty-globus_ssl_utils.version}"/>
	</target>
	
	<!-- ByPass -->
 	<target name="thirdparty-bypass">		
		<cvs command="checkout"
			package="org.egee.test3.wms.thirdparty-bypass"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.thirdparty-bypass.version}"/>
	</target>
	
	<!-- Globus GridFTP Server -->
 	<target name="thirdparty-globus_gridftp_server" depends="globus">		
		<cvs command="checkout"
			package="org.egee.test3.wms.thirdparty-globus_gridftp_server"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.thirdparty-globus_gridftp_server.version}"/>
	</target>
	
	<!-- Loki -->
 	<target name="thirdparty-loki">		
		<cvs command="checkout"
			package="org.egee.test3.wms.thirdparty-loki"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.thirdparty-loki.version}"/>
	</target>
	
	<!-- Common -->
 	<target name="common" depends="boost,classads,globus">		
		<cvs command="checkout"
			package="org.egee.test3.wms.common"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.common.version}"/>
	</target>
	
	<!-- JCommon -->
 	<target name="jcommon" depends="jclassads">		
		<cvs command="checkout"
			package="org.egee.test3.wms.jcommon"
			dest="${workspace.dir}"
			tag="${org.egee.test3.wms.jcommon.version}"/>
	</target>
	
	<!-- ====================================================
		 Checkout all
		 ==================================================== -->
	
	<!-- All libraries -->
 	<target name="all" depends="org.egee, org.egee.test3.wms, envchecks, devtools, project" />		

	<!-- ====================================================
		 Print dependecies to console
		 ==================================================== -->
	
 	<target name="dependencies">
 		<concat>
 			<fileset dir="." includes="dependencies.properties" />
 		</concat>
 	</target>		

</project>
